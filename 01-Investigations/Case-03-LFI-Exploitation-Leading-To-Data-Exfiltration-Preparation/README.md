# Case 03 — LFI Exploitation → Privilege Escalation, Persistence & Exfiltration Prep

**Category:** Web Exploitation → Local File Inclusion (LFI) → Post-Exploitation  
**Environment:** Linux Web Server  
**Artifacts Analyzed:** Apache Access Logs, Audit Logs, Syslog, File System  
**MITRE Focus:**  
- T1190 — Exploit Public-Facing Application  
- T1059 — Command Execution  
- T1068 — Privilege Escalation  
- T1053.003 — Cron Persistence  
- T1078 — Valid Accounts  
- T1560 — Archive Collected Data  

---

# 1. Scenario Overview
This case explores a full compromise of a Linux-based e-commerce server caused by an attacker exploiting a **Local File Inclusion (LFI)** vulnerability.

After successfully exploiting the vulnerable PHP script, the attacker:
- Retrieved sensitive system files  
- Logged in using stolen credentials  
- Executed binaries from unusual file paths  
- Installed cron-based persistence  
- Modified privileged configuration files  
- Created a backdoor user  
- Prepared sensitive files for exfiltration  


---

# 2. Objectives
As SOC analysts, our investigation goals are to:

- Identify the **PHP script** exploited using LFI  
- Determine the **first user account** the attacker logged in as  
- Identify **unusual executable paths**  
- Verify **cron persistence mechanisms**  
- Confirm **privilege escalation** activity  
- Identify **archive files** created for exfiltration  
- Identify **unauthorized user creation**  
- Identify the **privileged group** the attacker added themselves to  

---

# 3. Initial Access — Apache Log Review
To identify which PHP script was exploited, the Apache logs were searched:

```
grep php *
```
<img width="1416" height="214" alt="Screenshot 2025-12-02 at 7 45 06 PM" src="https://github.com/user-attachments/assets/a3935aa3-de52-4a1b-878a-d86efe7c1615" />


A suspicious request included directory traversal:

```
/products/memory/description.php?file=../../../../etc/passwd
```

**Answer: description.php**

---

# 4. First Compromised User — Login Review
To identify which account the attacker accessed after retrieving `/etc/passwd`:

```
lastlog | grep -v "Never"
```
<img width="1154" height="394" alt="Screenshot 2025-12-02 at 7 46 21 PM" src="https://github.com/user-attachments/assets/df949e14-847a-4814-b42a-cfa24bae9dd4" />



A recent login revealed:

**Answer: jeremy**

---

# 5. Suspicious Execution — Rogue Binary in /dev/shm
Audit logs were reviewed for process execution:

```
grep "EXECVE" audit.log*
```

A malicious binary was found executing from:

```
/dev/shm/systemctl
```

<img width="1157" height="514" alt="Screenshot 2025-12-02 at 7 48 18 PM" src="https://github.com/user-attachments/assets/ff4f8fa4-0937-4860-b367-dc879f3adb60" />

This cmd below helped me removed excess info and focused on only output of a0, a1 and a2. Which contained the paths

grep "EXECVE" audit.log* | awk '{
  exe=""; a0=""; a1=""; a2="";
  for(i=1; i<=NF; i++) {
    if ($i ~ /^exe=/) exe=$i;
    if ($i ~ /^a0=/) a0=$i;
    if ($i ~ /^a1=/) a1=$i;
    if ($i ~ /^a2=/) a2=$i;
  }
  print exe, a0, a1, a2
}'

<img width="732" height="509" alt="Screenshot 2025-12-02 at 7 49 08 PM" src="https://github.com/user-attachments/assets/8e10aade-8e44-4b2b-b354-6e6f456e0a9e" />

systemctl in the location of /dev/shm path is suspicious as it is usually located in usr/bin/systemctl. The presence of a systemctl binary within /dev/shm/ indicates a strong likelihood that the attacker placed a rogue or modified version of the binary in a writable shared memory location.

**Answer: /dev/shm/systemctl**

---

# 6. Persistence — Cron Job Modification
Syslog was reviewed for cron activity:

```
grep -i cron /var/log/syslog*
```

<img width="932" height="513" alt="Screenshot 2025-12-02 at 7 51 55 PM" src="https://github.com/user-attachments/assets/a1ff348f-f419-4d34-a156-f249dd0419f6" />


A cron job executed the rogue systemctl:

```
systemctl list-units --type=service --state=running | grep apache > /root/running_services.txt
```

Because the systemctl in use was the one inside `/dev/shm/`, this served as persistence.

**Answer: Malicious cron executing rogue systemctl**

---

# 7. Privilege Escalation — Modified /etc/sudoers
Privilege escalation was analyzed by inspecting sudoers:

```
ls -lah /etc/sudoers
cat /etc/sudoers
```
<img width="1012" height="405" alt="Screenshot 2025-12-02 at 7 52 46 PM" src="https://github.com/user-attachments/assets/4a5c4f68-bf09-4508-9080-8bf55a50c775" />


cat /etc/sudoers
<img width="538" height="527" alt="Screenshot 2025-12-02 at 7 53 19 PM" src="https://github.com/user-attachments/assets/579a36e0-4d73-463e-970f-56fc1106017e" />


The attacker added:

```
ALL=(ALL) NOPASSWD: ALL
```

**Answer: /etc/sudoers**

---

# 8. Data Exfiltration Preparation — Archive File Located
To identify any suspicious compressed archives:

```
grep "\.gz" /var/log/audit/audit.log*
```
<img width="1360" height="475" alt="Screenshot 2025-12-02 at 7 53 59 PM" src="https://github.com/user-attachments/assets/a8308eac-b254-471d-ae9f-5313a81c4d1a" />



A suspicious archive was discovered:

**Answer: archive1.tar.gz**

---

# 9. Persistence — Unauthorized User Created
Audit logs were reviewed for user creation:

```
grep -E "EXECVE.*useradd" /var/log/audit/audit.log*
```
<img width="1412" height="223" alt="Screenshot 2025-12-02 at 7 54 25 PM" src="https://github.com/user-attachments/assets/f1a1c0ce-29f5-441f-939a-5dc00dc34526" />



The attacker created a backdoor account:

**Answer: ftp**

---

# 10. Privileged Group Assigned to Backdoor User
To check the group membership of the unauthorized user:

```
groups ftp
```
<img width="1007" height="229" alt="Screenshot 2025-12-02 at 7 54 53 PM" src="https://github.com/user-attachments/assets/bd6b9c49-0f06-4e8e-88e4-11e86b9bb1eb" />



The account was added to:

**Answer: sudo**

---

# 11. Summary
This investigation confirms the following attacker actions:

- **Initial access:** LFI exploit in `description.php`  
- **Credential access:** The attacker retrieved `/etc/passwd`  
- **First login:** User `jeremy`  
- **Execution:** Rogue binary `/dev/shm/systemctl`  
- **Persistence:** Cron job calling malicious systemctl  
- **Privilege escalation:** Modified `/etc/sudoers` for NOPASSWD access  
- **Exfiltration prep:** Created `archive1.tar.gz`  
- **Persistence (backdoor accounts):** Created user `ftp` and added it to `sudo` group  

This represents a complete attack lifecycle from exploitation to persistence and exfiltration preparation.
